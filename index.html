<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Interactive Trail Map v1.007</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
  #map { height: 90vh; }
  #controls { margin: 10px; }
  .route-button { margin: 5px; padding: 5px 10px; cursor: pointer; }
  .route-button.active { background-color: lightblue; }
</style>
</head>
<body>

<div id="map"></div>
<div id="controls">
  <label for="trailFilter">Trail Mode:</label>
  <select id="trailFilter">
    <option value="all">All</option>
    <option value="été">Été + Saison</option>
    <option value="hiver">Hiver + Saison</option>
  </select>
</div>

<div id="route-options"></div>
<div id="directions"></div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script>
let map = L.map('map').setView([45.6, -73.8], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);

let trailData; // GeoJSON loaded separately
let trailLine;
let startMarker, endMarker;
let clickState = 0;
let routes = [];

const trailFilterSelect = document.getElementById('trailFilter');
trailFilterSelect.addEventListener('change', () => {
  renderTrails();
  resetRouting();
});

function resetRouting() {
  if (startMarker) map.removeLayer(startMarker);
  if (endMarker) map.removeLayer(endMarker);
  startMarker = endMarker = null;
  clickState = 0;
  clearRoutes();
}

function clearRoutes() {
  routes.forEach(r => map.removeLayer(r.layer));
  routes = [];
  document.getElementById('route-options').innerHTML = '';
  document.getElementById('directions').innerHTML = '';
}

function renderTrails() {
  if (trailLine) map.removeLayer(trailLine);
  const mode = trailFilterSelect.value;
  const filtered = (mode === 'all') ? trailData.features :
    trailData.features.filter(f => {
      const saison = f.properties.saison || 'all';
      return mode === 'été' ? (saison === 'été' || saison === 'saison') :
             mode === 'hiver' ? (saison === 'hiver' || saison === 'saison') : true;
    });
  trailLine = L.geoJSON({ type: 'FeatureCollection', features: filtered }).addTo(map);
}

map.on('click', function(e) {
  const snapped = turf.nearestPointOnLine(turf.lineString(trailLine.toGeoJSON().features.flatMap(f => f.geometry.coordinates)), turf.point([e.latlng.lng, e.latlng.lat]));
  const snappedCoords = [...snapped.geometry.coordinates];
  if (clickState === 0) {
    if (startMarker) map.removeLayer(startMarker);
    startMarker = L.marker([snappedCoords[1], snappedCoords[0]], {icon: L.icon({iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png', iconSize: [32, 32]})}).addTo(map);
    clickState = 1;
  } else if (clickState === 1) {
    if (endMarker) map.removeLayer(endMarker);
    endMarker = L.marker([snappedCoords[1], snappedCoords[0]], {icon: L.icon({iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png', iconSize: [32, 32]})}).addTo(map);
    findMultipleRoutes([startMarker.getLatLng().lng, startMarker.getLatLng().lat], [endMarker.getLatLng().lng, endMarker.getLatLng().lat]);
    clickState = 2;
  } else {
    resetRouting();
  }
});

function findMultipleRoutes(start, end) {
  clearRoutes();
  // Simulate 3 different routes for now - replace with your real routing
  for (let i = 0; i < 3; i++) {
    const route = turf.lineString([start, end]);
    const layer = L.geoJSON(route, { color: ['blue', 'green', 'purple'][i % 3] }).addTo(map);
    routes.push({layer, route});
  }
  renderRouteOptions();
}

function renderRouteOptions() {
  const container = document.getElementById('route-options');
  container.innerHTML = '';
  routes.forEach((r, i) => {
    const btn = document.createElement('button');
    btn.className = 'route-button';
    btn.textContent = `Route ${i+1}`;
    btn.onclick = () => {
      selectRoute(i);
    };
    container.appendChild(btn);
  });
}

function selectRoute(index) {
  routes.forEach((r, i) => {
    if (i === index) {
      r.layer.setStyle({ weight: 5 });
    } else {
      r.layer.setStyle({ weight: 2 });
    }
  });
  showDirections(index);
}

function showDirections(index) {
  const dirContainer = document.getElementById('directions');
  dirContainer.innerHTML = `<p>Directions for Route ${index+1}:<br>Go straight from Start to End.</p>`;
}

// Load trail data
fetch('map.geojson')
  .then(response => response.json())
  .then(data => {
    trailData = data;
    renderTrails();
  });
</script>

</body>
</html>
